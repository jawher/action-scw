name: Auto-merge upgrade PRs

on:
  pull_request_target:
    types: [labeled]
  check_suite:
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run on PRs with the automated-upgrade label
    if: github.event_name == 'pull_request_target' || (github.event.check_suite.conclusion == 'success' && github.event.check_suite.pull_requests[0] != null)

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_API_PAT }}
          script: |
            let pr_number;

            if (context.eventName === 'pull_request_target') {
              pr_number = context.payload.pull_request.number;
            } else if (context.eventName === 'check_suite') {
              pr_number = context.payload.check_suite.pull_requests[0].number;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_request_number: pr_number
            });

            return {
              number: pr.number,
              labels: pr.labels.map(l => l.name),
              head_sha: pr.head.sha,
              mergeable_state: pr.mergeable_state
            };

      - name: Check if automated upgrade PR
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            const pr = ${{ steps.pr.outputs.result }};
            const isAutomatedUpgrade = pr.labels.includes('automated-upgrade');

            console.log(`PR #${pr.number} is automated upgrade: ${isAutomatedUpgrade}`);
            console.log(`Labels: ${pr.labels.join(', ')}`);

            return isAutomatedUpgrade;

      - name: Wait for CI to complete and merge
        if: steps.check.outputs.result == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_API_PAT }}
          script: |
            const pr = ${{ steps.pr.outputs.result }};
            const maxAttempts = 30;
            const delayMs = 10000; // 10 seconds

            async function checkAndMerge() {
              for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                console.log(`Attempt ${attempt}/${maxAttempts}: Checking CI status...`);

                // Get all check runs for this commit
                const { data: checkRuns } = await github.rest.checks.listForRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: pr.head_sha,
                });

                // Get all status checks
                const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: pr.head_sha,
                });

                const allChecks = checkRuns.check_runs;
                const pending = allChecks.filter(c => c.status !== 'completed');
                const failed = allChecks.filter(c => c.conclusion === 'failure' || c.conclusion === 'cancelled');

                console.log(`Total checks: ${allChecks.length}, Pending: ${pending.length}, Failed: ${failed.length}`);
                console.log(`Combined status: ${statuses.state}`);

                if (failed.length > 0) {
                  console.log('Some checks failed. Will not auto-merge.');
                  console.log('Failed checks:', failed.map(c => c.name).join(', '));
                  return;
                }

                if (pending.length === 0 && statuses.state === 'success') {
                  console.log('All checks passed! Proceeding to merge...');

                  try {
                    await github.rest.pulls.merge({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      pull_request_number: pr.number,
                      commit_title: `Upgrade to scw-cli (auto-merged)`,
                      merge_method: 'squash'
                    });

                    console.log(`Successfully merged PR #${pr.number}`);
                    return;
                  } catch (error) {
                    console.error('Failed to merge:', error.message);
                    throw error;
                  }
                }

                if (attempt < maxAttempts) {
                  console.log(`Waiting ${delayMs/1000} seconds before next check...`);
                  await new Promise(resolve => setTimeout(resolve, delayMs));
                }
              }

              console.log('Timeout waiting for checks to complete');
            }

            await checkAndMerge();
